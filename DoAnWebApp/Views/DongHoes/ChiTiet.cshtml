@using DoAnWebApp.Models
@using System.Globalization
@{
    Layout = null;
    var sp = ViewBag.sp as DongHo;
    var culture = new CultureInfo("vi-VN");
    var hetHang = sp?.SoLuongTon <= 0;
}
<html>
<head>
    <meta charset="utf-8" />
    <title>Chi tiết sản phẩm</title>
    <link href="~/css/chitiet.css" rel="stylesheet" />
    <link href="~/css/popupauth.css" rel="stylesheet" />
</head>
<body>
    @if (sp != null)
    {
        <div class="container">
            <div class="image">
                <img src="~/IMG/@sp.Anh" alt="@sp.TenSP" />
            </div>
            <div class="info">
                <h2>@sp.TenSP</h2>
                <p class="price">@sp.DonGia.ToString("#,###", culture) VND</p>
                <p class="desc">@sp.MoTa</p>
                <p class="detail"><br />@Html.Raw(sp.MoTaChiTiet)</p>

                @* Hiển thị trạng thái tồn kho *@
                @if (hetHang)
                {
                    <p class="out-of-stock">HẾT HÀNG</p>
                }
                else
                {
                    <p><b>Số lượng còn:</b> @sp.SoLuongTon</p>
                }

                <!-- Hiển thị thông báo lỗi nếu có -->
                @if (TempData["Error"] != null)
                {
                    <div class="alert alert-error">
                        ⚠️ @TempData["Error"]
                    </div>
                }

                @if (TempData["Message"] != null)
                {
                    <div class="alert alert-success">
                        ✓ @TempData["Message"]
                    </div>
                }

                <form method="post" style="display:inline-block;">
                    <input type="hidden" name="maSP" value="@sp.MaSP" />

                    @if (!hetHang)
                    {
                        <input type="number"
                               name="soLuong"
                               value="1"
                               min="1"
                               max="@sp.SoLuongTon"
                               style="width:60px" />
                    }

                    <button formaction="@Url.Action("ThemVaoGio", "GioHang")"
                            class="btn @(hetHang ? "btn-disabled" : "")"
                            type="submit"
                            @(hetHang ? "disabled" : "")>
                        🛒 Thêm vào giỏ
                    </button>

                    <button formaction="@Url.Action("MuaNgay", "MuaNgay")"
                            class="btn btn-buy @(hetHang ? "btn-disabled" : "")"
                            type="submit"
                            @(hetHang ? "disabled" : "")>
                        ⚡ Mua ngay
                    </button>
                </form>
                <br /><br />
                <a href="@Url.Action("Index", "DongHoes")" class="back">⬅ Quay lại trang chủ</a>
            </div>
        </div>
    }
    else
    {
        <p style="text-align:center; margin-top:50px;">Không tìm thấy thông tin sản phẩm.</p>
    }

    <!-- Popup Đăng nhập -->
    <div class="modal" id="FormDangNhap">
        <div class="popup-content">
            <span class="close-btn" onclick="closePopup('FormDangNhap')">&times;</span>
            <h2>ĐĂNG NHẬP</h2>

            @if (TempData["Error"] != null && TempData["AuthTask"]?.ToString() == "dangnhap")
            {
                <p class="error-msg">@TempData["Error"]</p>
            }

            <form asp-controller="Auth" asp-action="Login" method="post">
                <input type="hidden" name="returnUrl" value="@($"/DongHoes/Details?MaSP={sp?.MaSP}")" />
                <input type="text" name="username" placeholder="Tên đăng nhập" required />
                <input type="password" name="password" placeholder="Mật khẩu" required />
                <button type="submit" class="sbm_button">Đăng nhập</button>
            </form>

            <p>
                Chưa có tài khoản?
                <a href="@Url.Action("Index", "DongHoes")">Đăng ký ngay</a>
            </p>
        </div>
    </div>

    <style>
        /* Style cho thông báo HẾT HÀNG */

      
        .out-of-stock {
            color: #ff0000;
            font-weight: bold;
            padding: 10px 18px;
            background-color: #ffe0e0;
            border: 2px solid #ff0000;
            border-radius: 5px;
            display: inline-block;
            animation: pulse 2s infinite;
            font-size: 16px; 
        }

        @@keyframes pulse {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* Style cho nút bị disabled */
        .btn-disabled {
            background: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed !important;
            opacity: 0.5;
            pointer-events: none;
        }

            .btn-disabled:hover {
                transform: none !important;
                box-shadow: none !important;
            }

        /* Style cho thông báo */
        .alert {
            padding: 12px 20px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
            animation: slideIn 0.3s ease;
        }

        .alert-error {
            background-color: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }

        .alert-success {
            background-color: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }

        @@keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Style cho nút Mua ngay */
        .btn-buy {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            margin-left: 10px;
        }

            .btn-buy:hover {
                background: linear-gradient(135deg, #ff5252, #ff3838);
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(255, 82, 82, 0.4);
            }

        /* Style cho input số lượng */
        input[type="number"] {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            margin-right: 10px;
        }

            input[type="number"]:focus {
                outline: none;
                border-color: #667eea;
            }

        .error-msg {
            color: red;
            font-weight: bold;
            margin-bottom: 10px;
        }
    </style>

    <script>
        // Mở popup đăng nhập nếu cần
        window.onload = function() {
            var authTask = '@TempData["AuthTask"]';
            if (authTask === 'dangnhap') {
                openPopup('FormDangNhap');
            }
        }

        function openPopup(id) {
            document.getElementById(id).style.display = 'flex';
        }

        function closePopup(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Tự động ẩn thông báo sau 5 giây
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.style.opacity = '0';
                    alert.style.transition = 'opacity 0.5s ease';
                    setTimeout(() => alert.remove(), 500);
                }, 5000);
            });
        });
    </script>
</body>
</html>